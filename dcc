#!/bin/bash

path_dir="."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Detect Docker Compose command
if command -v docker compose >/dev/null 2>&1; then
    DC_CMD="docker compose"
elif command -v docker-compose >/dev/null 2>&1; then
    DC_CMD="docker-compose"
else
    echo -e "${RED}Docker Compose not found.${NC}"
    exit 1
fi

# Check if up
check_docker_status() {
    local file="$1"
    if $DC_CMD -f "$file" ps --quiet 2>/dev/null | grep -q .; then
        echo -e "${GREEN}up${NC}"
    else
        echo -e "${RED}down${NC}"
    fi
}

# Find docker-compose.yaml or docker-compose.yml in all immediate subdirectories
compose_files=($(find . -maxdepth 2 -type f \( -name "docker-compose.yaml" -o -name "docker-compose.yml" \)))

if [ ${#compose_files[@]} -eq 0 ]; then
    echo -e "${RED}Can't find docker-compose.yaml or docker-compose.yml files in any subdirectories.${NC}"
    exit 0
fi

# List status
echo "Found files:"
for i in "${!compose_files[@]}"; do
    status=$(check_docker_status "${compose_files[i]}")
    dirname=$(basename "$(dirname "${compose_files[i]}")")
    printf "%-3s %-40s %-20s\n" "$((i+1))." "${dirname}" "[Stack is $status]"
done

echo "Enter Files(1 || 1,3 | a = all), q=quit"
read -r choice

# Input
selected_files=()
if [ "$choice" == "q" ]; then
    exit 0
elif [ "$choice" == "a" ]; then
    selected_files=("${compose_files[@]}")
else
    IFS=',' read -ra selected_indices <<< "$choice"
    for index in "${selected_indices[@]}"; do
        adjusted_index=$((index-1))
        if [ $adjusted_index -lt 0 ] || [ $adjusted_index -ge ${#compose_files[@]} ]; then
            echo -e "${RED}Invalid choice${NC}"
            exit 1
        fi
        selected_files+=("${compose_files[$adjusted_index]}")
    done
fi

echo "Do What? (u = up || d = down)"
read action

# Validate and map to full commands
if [ "$action" == "u" ]; then
    action="up"
elif [ "$action" == "d" ]; then
    action="down"
else
    echo -e "${RED}Invalid action${NC}"
    exit 1
fi

# Execute
for file in "${selected_files[@]}"; do
    project=$(basename "$(dirname "$file")")
    echo -e "\n${GREEN}[$action â†’ $project]${NC}"
    if [ "$action" == "up" ]; then
        $DC_CMD -f "$file" up -d
    else
        $DC_CMD -f "$file" down
    fi
done
